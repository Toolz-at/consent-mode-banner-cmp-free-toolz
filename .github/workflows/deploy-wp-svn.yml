# Workflow to deploy the plugin to WordPress.org SVN when changes land on main
name: Deploy to WordPress.org SVN

on:
  push:
    branches:
      - main # Only run deployments from the main branch

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository # Fetch repository contents for deployment
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract plugin version # Read Version: from the plugin header and expose it as an output
        id: vars
        run: |
          set -euo pipefail
          if [[ ! -f "consent-mode-banner-cmp-toolz.php" ]]; then
            echo "::error::Main plugin file 'consent-mode-banner-cmp-toolz.php' not found."
            exit 1
          fi
          VERSION=$(grep -E "^\s*\*\s*Version:\s*[0-9]+\.[0-9]+\.[0-9]+\s*$" consent-mode-banner-cmp-toolz.php | head -n 1 | sed -E "s/^\s*\*\s*Version:\s*([0-9]+\.[0-9]+\.[0-9]+)\s*$/\1/")
          if [[ -z "${VERSION}" ]]; then
            echo "::error::Could not find a valid Version header (MAJOR.MINOR.PATCH) in consent-mode-banner-cmp-toolz.php."
            exit 1
          fi
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"
          echo "Detected plugin version: ${VERSION}"

      - name: Validate plugin header version # Ensure the plugin header still matches the detected version
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -euo pipefail
          if ! grep -Eq "^\s*\*\s*Version:\s*${VERSION}\s*$" consent-mode-banner-cmp-toolz.php; then
            echo "::error::Plugin header Version does not match '${VERSION}'."
            exit 1
          fi

      - name: Validate readme Stable Tag # Ensure readme.txt Stable Tag equals the plugin version
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -euo pipefail
          if [[ ! -f "readme.txt" ]]; then
            echo "::error::File 'readme.txt' not found in repository root."
            exit 1
          fi
          if ! grep -Ei "^Stable tag:\s*${VERSION}\s*$" readme.txt; then
            if grep -Ei "^Stable tag:" readme.txt; then
              CURRENT=$(grep -Ei "^Stable tag:" readme.txt | head -n 1 | sed -E "s/^[Ss]table [Tt]ag:\s*([^[:space:]]+).*/\1/")
              echo "::error::Stable tag in readme.txt is '${CURRENT}', expected '${VERSION}'."
            else
              echo "::error::Could not find a Stable tag line in readme.txt."
            fi
            exit 1
          fi

      - name: Prepare WordPress.org assets # Copy assets/ into .wordpress-org/ so the deploy action can publish them
        run: |
          set -euo pipefail
          if [[ -d "assets" ]]; then
            rm -rf .wordpress-org
            mkdir .wordpress-org
            cp -R assets/. .wordpress-org/
            echo "Copied assets/ to .wordpress-org/."
          else
            echo "No assets directory found; skipping asset preparation."
          fi

      - name: Deploy to WordPress.org # Run the official deploy action with the extracted version
        id: deploy
        uses: 10up/action-wordpress-plugin-deploy@2.3.0
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          SLUG: consent-mode-banner-cmp-free-toolz
          VERSION: ${{ steps.vars.outputs.version }}
        with:
          generate-zip: true

      - name: Upload release ZIP artifact # Publish the generated ZIP for reference
        uses: actions/upload-artifact@v4
        with:
          name: consent-mode-banner-cmp-free-toolz-${{ steps.vars.outputs.version }}.zip
          path: ${{ steps.deploy.outputs.zip-path }}
          if-no-files-found: error
